name: 🚀 Provisioning VM from External Project

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: "VM Name"
        required: true
        default: "devops-vm"

      vm_memory:
        description: "Memory (MB)"
        required: true
        default: "8192"
        type: choice
        options:
          - "1024"
          - "2048"
          - "4096"
          - "6144"
          - "8192"

      vm_cpus:
        description: "Number of CPUs"
        required: true
        default: "4"
        type: choice
        options:
          - "1"
          - "2"
          - "3"
          - "4"
          - "5"
          - "6"

      ip_mode:
        description: "IP Mode (dhcp or static)"
        required: true
        default: "dhcp"
        type: choice
        options:
          - dhcp
          - static

      ip_address:
        description: "Static IP (if IP Mode is static)"
        required: false

      project_repo:
        description: "GitHub repo to provision (e.g. vladbelo2/gameops-lab)"
        required: true
        default: "vladbelo2/gameops-lab"

jobs:
  spin-vm:
    name: 🧱 Spin VM for ${{ github.event.inputs.project_repo }}
    runs-on: [self-hosted, macos, X64]

    steps:
      - name: 📁 Checkout Orchestrator Repo
        uses: actions/checkout@v4

      - name: 📦 Clone External Project
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.project_repo }}
          path: external/project

      - name: 🔧 Generate Vagrantfile
        run: |
          chmod +x scripts/build_vagrantfile.py
          python3 scripts/build_vagrantfile.py \
            --vm-name "${{ github.event.inputs.vm_name }}" \
            --vm-memory "${{ github.event.inputs.vm_memory }}" \
            --vm-cpus "${{ github.event.inputs.vm_cpus }}" \
            --ip-mode "${{ github.event.inputs.ip_mode }}" \
            --ip-address "${{ github.event.inputs.ip_address }}"

      - name: 🔄 Copy Project Files Into VM Dir
        run: |
          cp -r external/project/* vms/${{ github.event.inputs.vm_name }}/

      - name: 🧱 vagrant up
        working-directory: ./vms/${{ github.event.inputs.vm_name }}
        run: |
          vagrant up

      - name: ⚙️ Provision Project VM
        working-directory: ./vms/${{ github.event.inputs.vm_name }}
        run: |
          vagrant ssh -c "bash /vagrant/provision.sh"
